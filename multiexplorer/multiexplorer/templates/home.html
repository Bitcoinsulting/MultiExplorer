{% extends "base.html" %}
{% load staticfiles %}

{% block content %}

<h1>MultiExplorer</h1>

<section id="address_balance">
    <h2>Address Balance</h2>
    <input type="text" name="address_balance_input_box" class="address" placeholder="Enter Address" value="{{ TEST_ADDRESS }}">
    <input type="submit" id="address_balance_button" value="Get Balance">

    <div id="address_balance_results" class="results_container"></div>
</section>

<section  id="get_block">
    <h2>Block Information</h2>
    <select name="block_info">
        {% for currency in block_info_currencies %}
        <option value="{{ currency.code }}">{{ currency.code|upper }} - {{ currency.name }}</option>
        {% endfor %}
    </select>

    <br><br>

    <input type="text" class="block_number" name="block_number_input_box" placeholder="Enter Block Height">
    <input type="submit" value="Get Block By Height">

    <br><br>

    <input type="text" class="block_hash" name="block_hash_input_box" placeholder="Enter Block Hash">
    <input type="submit" value="Get Block By Hash">

    <br><br>

    <input type="submit" value="Get Block By Latest">

    <div id="aggregated_get_block" class="aggregated_container"></div>
    <div id="get_block_results" class="results_container"></div>
</section>


<section block="unspent_outputs">
    <h2>Get UTXOs for address</h2>
    <input type="text" class="address" name="unspent_outputs_input_box" placeholder="Enter Address" value="{{ TEST_ADDRESS }}">
    <input type="submit" id="unspent_outputs_button" value="Get UTXOs">

    <div id="aggregated_unspent_outputs" class="aggregated_container"></div>
    <div id="unspent_outputs_results" class="results_container"></div>
</section>

<section id="api">
    <h2>API</h2>


    <h3>Pass through JSON API</h3>

    Use a single blockexplorer API via multiexplorer as a pass-thtough.
    Service_id is a number cooresponding to the serivice in the table below.

    {{ service_table|safe }}

    <h3>Address Balance</h3>
    http://{{ domain }}/api/<i>[currency]</i>/address_balance/<i>[service_id]</i>?address=<i>[address]</i>

    <br><br>


    <br>
    <div class="examples">
        <div class='title'>Examples:</div>
        http://{{ domain }}/api/BTC/address_balance/5?address=1M9XB8No8MnNjJvzPrtKyAnRfWwgMYr2Jp<br>
        http://{{ domain }}/api/LTC/address_balance/5?address=LVyKFjC1Xgu7QiADYszzHC6hSFfDELgi7n
    </div>

    <br><br>
    Service number 5 corresponds to Blockr.io. This API call will return data from
    the Blockr.io service. The response will look like this:

    <br>
    <br>

    <div class="code_wrapper">
        <code>
        <pre>
        {
            "balance": 20,
            "cache_hit": true,
            "raw_response": {
                "code": 200,
                "data": {
                    "address": "1PZ3Ps9RvCmUW1s1rHE25FeR8vtKUrhEai",
                    "balance": 20,
                    "balance_multisig": 0,
                    "first_tx": {
                        "block_nb": "306478",
                        "confirmations": 94860,
                        "time_utc": "2014-06-18T11:10:58Z",
                        "tx": "be39fcb60f7ca0b9976f86e46ffb1acb87f3ec28d09171515da8470e8dd45e51",
                        "value": 0.001
                    },
                    "is_unknown": false,
                    "is_valid": true,
                    "last_tx": {
                        "block_nb": "306479",
                        "confirmations": 94859,
                        "time_utc": "2014-06-18T11:17:31Z",
                        "tx": "f466e441f7fa7a6b9608fe4887721f01c0cfc3472c02f29fd69d64eb96a47434",
                        "value": 19.999
                    },
                    "nb_txs": 2,
                    "totalreceived": 20
                },
                "message": "",
                "status": "success"
            },
            "service_name": "Blockr.io",
            "timestamp": 1457221865,
            "url": "http://btc.blockr.io/api/v1/address/info/1PZ3Ps9RvCmUW1s1rHE25FeR8vtKUrhEai"
        }
        </pre>
        </code>
    </div>

</section>

<section id="footer">
    Built Using <a href="https://github.com/priestc/moneywagon">Moneywagon</a>. <a href="https://github.com/priestc/MultiExplorer">Github</a>
</section>

<div style="display: none">
    <img src='{% static 'spin.gif' %}'>
</div>

<style>
    .service_call {
        border: 1px solid black;
        background: #dfdfdf;
        margin: 5px;
        padding: 3px;
        width: 300px;
        min-height: 40px;
        overflow: hidden;
    }
    .service_title {
        width: 40px;
    }

    input.address {
        width: 22em;
    }

    input.height {
        width: 6em;
    }

    input.block_hash {
        width: 30em;
    }

    .error {
        color: red;
    }

    .result {
        float: right;
    }

    .final_result {
        font-weight: bold;
    }

    .matches {
        color: green
    }

    .not-matches {
        color: red;
    }

    .utxo_table {
        margin: 10px;
        width: 25em;
        background: #FFD19E;
    }

    section {
        background: #D6FFED;
        border: 1px solid brown;
        margin: 10px;
        padding: 15px;
        text-align: center;
        border-radius: 7px;
    }

    #api {
        background: #E1D6FF;
    }

    #api table {
        width: 50%;
        margin: 10px auto 10px auto;
    }

    #api table td {
        border: 1px solid white;
        padding: 3px;
    }

    #footer {
        background: transparent;
        border: 0px;
    }

    #address_balance {
        background: #FFF2D6;
    }

    #get_block {
        background: #FFD6FC;
    }

    h2 {
        padding-bottom: 15px;
        margin: 5px;
    }

    .results_container {
        overflow: hidden;
    }

    .service_call {
        float: left;
    }

    .aggregated_container {
        margin: 0 auto 0 auto;
        padding: 20px;
    }

    .utxo_table {
        margin: 5px auto 5px auto;
        border: 1px solid gray;
        padding: 5px;
        width: 100%;
    }

    .utxo_table td {
        text-align: left;
    }

    .code_wrapper {
        text-align: left;
        margin: 0 auto 0 auto;
        border: 1px solid gray;
        width: 50%;
        border-radius: 7px;
        background: #D9D9D9;
    }

    .examples {
        font-size: large;
        margin: 30px auto 30px auto;
        padding: 30px;
        background: #FFCECE;
        width: 75%;
    }

    .examples .title {
        font-family: helvetica;
        font-size: xx-large;
        text-align: left;
        font-weight: bold;
    }

</style>
<script src="{% static 'jquery-2.2.1.min.js' %}"></script
<script src="{% static 'bitcore.browser.min.js' %}"></script>

<script>
    var service_info = JSON.parse('{{ service_info_json|safe }}');
    var crypto_data = JSON.parse('{{ crypto_data_json|safe }}');
    var spinner = "<img src='{% static 'spin.gif' %}'>"

    $("#address_balance_button").click(function(event) {
        event.preventDefault();
        var address = $("input[name=address_balance_input_box]").val();
        $("#addres_balance .service_call").remove();
        currency = 'btc';

        present_results(
            currency, "address_balance", "?address=" + address,
            function(response, matches) {
                var mch_cls = matches ? "matches" : "not-matches";
                return "<span class='final_result " + mch_cls + "'><span class='balance'>" + response['balance'] + '</span> ' + currency.toUpperCase() + "</span>"
            },
            function(response, container) {
                var matched = 0;
                var new_value = response['balance'];
                var previous = container.find('.balance');

                if(previous.length == 0) {
                    return true;
                }

                $.each(previous, function(i, result) {
                    // each previous result
                    var numerical = parseInt($(result).text())
                    if(numerical == new_value) {
                        matched += 1;
                    }
                });

                return matched > (previous.length / 2);
                //console.log("Result", ret, matched, new_value, previous.length, response['service_name']);
                //return ret;
            }
        );
    });

    $("#unspent_outputs_button").click(function(event) {
        event.preventDefault();
        var address = $("input[name=unspent_outputs_input_box]").val();
        var aggregate_container = $("#aggregated_unspent_outputs").empty();
        $("#unspent_outputs .service_call").remove();

        var currency = "btc";

        present_results(
            currency, "unspent_outputs", "?address=" + address,
            function(response, matches) {
                if(aggregate_container.children().length == 0) {
                    // first response, place it on the aggregate container
                    //console.log("first result", response.service_name);
                    $.each(response['utxos'], function(i, utxo) {
                        var rows = "";
                        var table = $("<table class='utxo_table'></table>");
                        rows += "<tr><td>Confirmations</td><td class='confirmations'>" + utxo['confirmations'] + "</td></tr>";
                        rows += "<tr><td>Output</td><td class='output'>" + utxo['output'] + "</td></tr>";
                        rows += "<tr><td>Amount</td><td class='amount'>" + utxo['amount'] + "</td></tr>";
                        table.append(rows);
                        aggregate_container.append(table);
                    });
                }

                var match_class = matches ? "matches" : "not-matches";
                var match_text = matches ? "Matches" : "No Match";
                return "<span class='final_result " + match_class + "'>" + match_text + "</span>";
            },
            function(response, container) {
                // matches_func, compare existing, returns whether this is in consensus or not.
                var aggregated_utxos = aggregate_container.find(".utxo_table");
                var matches = true;

                //console.log("matches func");

                $.each(response['utxos'], function(i, utxo) {
                    var corresponding = $(aggregated_utxos[i]);
                    if(corresponding.length == 0) {
                        // first result! nothing to compare to yet. Consider Matched!
                        return false;
                    }

                    var matched_amount = parseInt(corresponding.find(".amount").text()) == parseInt(utxo['amount']);
                    var matched_output = corresponding.find(".output").text() == utxo['output'];

                    if(!matched_amount || !matched_output) {
                        matches = false;
                        return false; // stop iterating
                    }
                });

                return matches;
            }
        );
    });

    function present_results(currency, mode, api_args, format_result_func, matches_func) {
        var container = $("#" + mode + "_results");

        $.each(crypto_data[currency][mode], function(i, service_id) {
            // each service for the supported cyurrency
            var info = service_info[service_id];
            var url = info['url'];
            var service_name = info['name'];
            var a = "<a class='service_title' target='_blank' href='" + url + "'> (" + service_id + ') ' + service_name + "</a>";

            var result_selector = "service-" + mode + '-' + service_id;

            container.append(
                $("<div class='service_call'>" + a + "<div class='result " + result_selector + "'>" + spinner + "</div></div>")
            );

            var url = "/api/" + currency + "/" + mode + "/" + service_id + api_args;

            $.ajax({
                url: url,
            }).done(function(response) {

                matches = matches_func(response, container);

                var raw_link = "<a target='_blank' href='" + response['url'] + "'>Raw</a>";
                var api_link = "<a target='_blank' href='" + url + "&include_raw=true'>API</a>";
                $("." + result_selector).html(
                    format_result_func(response, matches) + '<br>' + raw_link + ' ' + api_link
                );

            }).fail(function(xhr, status, error) {
                var error_msg = xhr.responseJSON['error'];
                $("." + result_selector).html("<span class='error'>Error:" + error_msg + "</span>");
            });
        });
    };


</script>

{% endblock %}
